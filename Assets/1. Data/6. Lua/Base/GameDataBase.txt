GameDataBase = class()
local this = GameDataBase

local function InitDrawCard()
  local drawNum = GameData.drawNum
  -- 处理
  Debug.Log(drawNum)
  this:DrawCard(drawNum,true)
end

function this:DrawCard(num,init)
  if init==nil then
    init=false
  end
  --Debug.Log(num)
  local pileLen = GameData.drawPile.Count
  --Debug.Log(num)
  if num> pileLen then
    --Debug.Log('11111111')
    self:DrawCard(pileLen,false)
    if init then
      while GameData.graveyardPile.Count >0 do
        local n = math.random(0,GameData.graveyardPile.Count-1)
        GameData.drawPile.Add(GameData.graveyardPile[n])
        GameData.graveyardPile:RemoveAt(n)
      end
      self:DrawCard(num-pileLen,false)
    end
  else
    for i=0,num-1 do
      HandView:AddCard(GameData.drawPile[0])
      GameData.drawPile:RemoveAt(0)
    end
  end
end

function this:new()
  self.CurrentRound = 0
  self.Resource = {}
  self.Resource.Mine  = 0
  self.Resource.Iron = 0
  self.Resource.Wood = 0
  self.Resource.Food = 0
  self.Resource.TechPoint = 0
  self.Resource.FaithPoint = 0
  self.Resource.Pressure = 0
  self.Resource.Insight = 0
  self.Resource.DrawNum = 3
  self.Resource.Population = 20
  self.Resource.Labor = 20
  self.Resource.LaborAvailable = 20
  self.Resource.Residence = 0
  
  self.Build={}
  self.Build.Deck={}
  self.Build.Relic={}
  self.Build.BuildingDeck={}
  self.Build.Heros={}

  self.EventDeck={}

  self.inGame={}
  self.inGame.Hands={}
  self.inGame.DrawDeck={}
  self.inGame.RecycleDeck={}
  self.inGame.Buff={}
  self.inGame.LaborManager={}
  self.inGame.CurrentRound=0
  self.inGame.BDrawDeck={}
  self.inGame.BRecycleDeck={}
  self.inGame.BHands={}

  self.BuffTrigger={}
  self.BuffTrigger.BattleBegin={}
  self.BuffTrigger.RoundBegin={}
  self.BuffTrigger.RoundEnd={}

  EventService.Listen(GameEvent.EnterMainPhase, InitDrawCard)
end

function this:MineNFoodConsume()
  return  -----待修改 回合开始进行矿石和食物的消耗
end


function this:NewBattle() --一场战斗开始
  self.inGame.DrawDeck = self.Build.Deck
  self.inGame.BDrawDeck = self.Build.BuildingDeck
  for i = 1, #self.BuffTrigger.BattleBegin do
    self.BuffTrigger.BattleBegin[i].apply()
  end
end

function this:NewRound() --一回合开始
  for i = 1,#self.BuffTrigger.RoundBegin do
    self.BuffTrigger.RoundBegin[i].apply()
  end
  DrawCard(self.DrawNum, true)
end

local function SwitchInGame()LuaGameData = GameDataBase()end
EventService.Listen(GameEvent.EnterInGameState, SwitchInGame)